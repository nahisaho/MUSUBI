# 技術スタック

## 概要
このドキュメントは、本プロジェクトの技術選択、フレームワーク決定、技術的制約を定義します。すべての開発はこれらの技術的決定に沿って行う必要があります。

**最終更新日**: 2025-01-16 by @steering

## コア技術

### プログラミング言語
**プライマリ言語**: JavaScript (Node.js)
- **バージョン**: Node.js >=18.0.0
- **モジュールシステム**: CommonJS と動的ESMインポート
- **正当性**: 
  - Node.jsエコシステムでの普遍的な利用可能性
  - CLIツールはCommonJS互換性の恩恵を受ける
  - 動的import()によりESM依存関係サポートが可能 (inquirer v9)

**TypeScript なし**: 最大限の互換性のためJavaScriptのみ
- CLIツールはシンプルさと配布を優先
- トランスパイルステップ不要
- Node.jsでの直接実行

## フレームワーク & ライブラリ

### CLIフレームワーク
**プライマリフレームワーク**: commander ^11.0.0
- **目的**: コマンドラインインターフェイス解析とルーティング
- **機能**: サブコマンド、フラグ、ヘルプテキスト生成
- **使用法**: \`musubi init\`, \`musubi status\`, \`musubi validate\`, \`musubi info\`

### ターミナルスタイリング
**ライブラリ**: chalk ^4.1.2 (CommonJSバージョン)
- **目的**: 色付きターミナル出力、ANSIフォーマット
- **v4を選ぶ理由**: ESM専用のv5はCommonJSと非互換
- **使用法**: 成功(緑)、警告(黄)、エラー(赤)、情報(青)

### インタラクティブプロンプト
**ライブラリ**: inquirer ^9.0.0 (ESM専用)
- **目的**: インタラクティブCLIプロンプト (エージェント選択、プロジェクトタイプ、スキル選択)
- **インポートパターン**: 動的ESMインポート
  \`\`\`javascript
  const inquirer = await import('inquirer');
  await inquirer.default.prompt([...]);
  \`\`\`
- **機能**: チェックボックス、リスト選択、確認、入力検証

### ファイルシステムユーティリティ
**ライブラリ**: fs-extra ^11.0.0
- **目的**: 強化されたファイル操作 (コピー、ディレクトリ確保、JSON読み書き)
- **使用法**: \`src/templates/\` からユーザープロジェクトへのテンプレートコピー
- **利点**: Promiseベースのベース API、自動ディレクトリ作成

## 開発ツール

### パッケージ管理
- **パッケージマネージャー**: npm (Node.jsに同梱)
- **バージョン**: npm 10.x (Node.js 18+付属)
- **ロックファイル**: package-lock.json (リポジトリにコミット)
- **レジストリ**: npmjs.org (パブリックnpmレジストリ)

### ビルドツール
**ビルドステップ不要** - 直接JavaScript実行
- バンドラーなし (CLIツール、Webアプリケーションではない)
- トランスパイラーなし (JavaScript、TypeScriptではない)
- **タスクランナー**: npmスクリプトのみ

\`\`\`json
{
  "scripts": {
    "test": "jest",
    "lint": "eslint .",
    "format": "prettier --write ."
  }
}
\`\`\`

### テスト
**ユニットテスト**: jest ^29.0.0
- **テストファイル**: \`tests/*.test.js\`
- **テストカバレッジ目標**: 80% (憲法条項III)
- **テストランナー**: \`npm test\`

**統合/E2Eテスト未実装**
- 将来: 完全な \`musubi init\` ワークフロー用統合テスト
- 将来: テンプレート検証用スナップショットテスト

### コード品質
- **リンター**: eslint ^8.50.0
  - JavaScript標準ルール
  - Node.js環境
- **フォーマッター**: prettier ^3.0.0
  - シングルクォート、セミコロンなし
  - 100文字行幅
- **プレコミットフック**: 未設定 (将来: husky + lint-staged)

## デプロイ & インフラストラクチャ

### ホスティング
**プラットフォーム**: npm Registry (npmjs.org)
- **パッケージ名**: musubi-sdd
- **配布**: パブリックnpmパッケージ
- **インストール**: \`npx musubi-sdd\` (オンデマンド) または \`npm install -g musubi-sdd\`
- **レジストリURL**: https://www.npmjs.com/package/musubi-sdd

**アプリケーションホスティングなし** - MUSUBIはCLIツール、ホストサービスではない
- ユーザーはnpx/npm経由でローカル実行
- サーバー、コンテナ、クラウドインフラストラクチャなし
- npmエコシステムのみを通じた配布

### CI/CD
**パイプライン**: GitHub Actions (将来)
- **現在**: 手動公開ワークフロー
  1. package.jsonのバージョン更新
  2. \`npm publish\`
  3. \`git tag vX.Y.Z\`
  4. \`git push origin main --tags\`
- **将来**: 自動化されたCI/CDパイプライン
  - PRで自動テスト
  - バージョンタグで自動公開
  - 自動changelog生成

### モニタリング & ロギング
**モニタリングインフラストラクチャなし** - CLIツールはローカル実行
- ユーザーは自分のターミナルで出力を確認
- 集中ロギングなし
- アプリケーションモニタリングなし (Sentry、DataDogは適用外)
- **エラーハンドリング**: すべてのエラーはchalkで色付けされてユーザーに表示

## 技術的制約

### パフォーマンス要件
**適用外** - MUSUBIはローカルファイル操作用のCLIツール
- テンプレートコピー: < 1秒 (小さなファイル)
- インタラクティブプロンプト: 即座のユーザーフィードバック
- ネットワーク遅延なし (npmからの初回npxダウンロードを除く)

### プラットフォームサポート
- **Node.jsバージョン**: >=18.0.0 (package.jsonのengines要件)
- **オペレーティングシステム**: Linux、macOS、Windows (Node.jsが動作する場所)
- **シェル**: bash、zsh、PowerShell、cmd (任意のターミナル)
- **ブラウザ要件なし**: CLIツール、Webアプリケーションではない

### セキュリティ要件
**最小限のセキュリティ懸念** - ローカルCLIツール
- 認証/認可なし (ローカルファイル操作)
- データ暗号化なし (テンプレートは公開)
- シークレット管理なし (MUSUBI自体にシークレットなし)
- ユーザーはテンプレートインストール後、自分のプロジェクトセキュリティを管理

## サードパーティサービス

### 必須サービス
**npm Registry** (npmjs.org)
- **目的**: パッケージ配布とバージョニング
- **コスト**: パブリックパッケージは無料
- **依存性**: MUSUBIはnpmエコシステムなしでは機能しない

**他の外部サービスなし**
- データベースなし
- APIなし
- クラウドサービスなし
- 認証サービスなし

## 技術決定 & ADR

### アーキテクチャ決定記録

1. **決定**: ESMではなくCommonJSを使用
   - **理由**: 古いNode.jsバージョンとの互換性向上、配布が簡素化
   - **代替案**: 純粋なESM (Node.js 14+が必要、より多くの破壊的変更)
   - **日付**: 2024 (初期実装)
   - **ステータス**: 有効

2. **決定**: inquirer v9用の動的import()
   - **理由**: inquirer v9はESM専用だが、CLIをCommonJSで維持したい
   - **代替案**: inquirer v8にダウングレード (CommonJS)、CLI全体をESMに変換
   - **日付**: 2025-01 (v0.1.2バグ修正)
   - **ステータス**: 有効

3. **決定**: chalk v5ではなくv4
   - **理由**: v5は純粋なESM、CommonJS CLIと非互換
   - **代替案**: CLI全体をESMに移行
   - **日付**: 2024 (初期実装)
   - **ステータス**: 有効

4. **決定**: テンプレートベース配布 (シンボリックリンクではなくコピー)
   - **理由**: インストール後のテンプレートカスタマイズが必要
   - **代替案**: node_modulesへのシンボリックリンク (カスタマイズ不可)、Gitサブモジュール (複雑)
   - **日付**: 2024 (初期設計)
   - **ステータス**: 有効

5. **決定**: MarkdownとTOMLフォーマットの両方をサポート
   - **理由**: Gemini CLIはTOMLが必要、他はMarkdownを使用
   - **代替案**: Markdownのみ (Gemini CLI除外)、MarkdownからTOMLを生成
   - **日付**: 2024 (Gemini CLIサポート)
   - **ステータス**: 有効

## 非推奨技術

**現在なし** - MUSUBIは意図的な技術選択を持つ新しいプロジェクトです。

将来の検討事項:
- TypeScriptに移行する場合、移行計画をここに文書化
- inquirer v10+にアップグレードする場合、ESM移行戦略を文書化
- 新しい依存関係を追加する場合、根拠と代替案を文書化

## 開発環境セットアップ

### 前提条件
\`\`\`bash
# 必要なインストール
Node.js 18+ (LTS推奨)
npm 10+ (Node.js 18に同梱)
git (バージョン管理用)
\`\`\`

### MUSUBI開発のクイックスタート
\`\`\`bash
# リポジトリクローン
git clone https://github.com/nahisaho/musubi.git
cd musubi

# 依存関係インストール
npm install

# テスト実行
npm test

# ローカルでCLI試用
node bin/musubi.js --version
node bin/musubi-init.js  # インタラクティブプロンプト

# グローバルテスト用リンク
npm link
musubi --version

# 完了時にアンリンク
npm unlink -g musubi-sdd
\`\`\`

### 公開ワークフロー
\`\`\`bash
# 1. バージョン更新
npm version patch  # または minor、major

# 2. ローカルテスト
npx . init --claude

# 3. npmに公開
npm publish

# 4. GitHubにプッシュ
git push origin main --tags
\`\`\`

---

**注記**: このドキュメントはMUSUBIの技術スタックを記述しています - 最小限の依存関係を持つNode.js CLIツールです。新しい依存関係を追加したり、ビルドプロセスを変更する際は更新してください。

**最終更新日**: 2025-01-16 by @steering
